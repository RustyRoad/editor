<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Grapesjs Tailwind</title>
    <link href="https://unpkg.com/grapesjs/dist/css/grapes.min.css" rel="stylesheet">
    <script src="https://unpkg.com/grapesjs"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body,
        html {
            height: 100%;
            margin: 0;
        }

        .gjs-block {
            padding: 0 !important;
            width: 100% !important;
            min-height: auto !important;
        }

        .gjs-block svg {
            width: 100%;
        }

        .change-theme-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin: 5px;
        }

        .change-theme-button:focus {
            /* background-color: yellow; */
            outline: none;
            box-shadow: 0 0 0 2pt #c5c5c575;
        }
    </style>
</head>

<body>

    <div id="gjs" class="gjs-editor-cont" style="width: 100%; height: 100%;"> 

    </div>

    <style>
        body,
        html {
            height: 100%;
            margin: 0;
        }

        .gjs-block {
            padding: 0 !important;
            width: 100% !important;
            min-height: auto !important;
        }

        /* Make blocks full width */
        .gjs-block {
            padding: 0 !important;
            width: 100% !important;
            min-height: auto !important;
        }

        /* Fit icons properly */
        .gjs-block svg {
            width: 100%;
        }

        .change-theme-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin: 5px;
        }

        .change-theme-button:focus {
            /* background-color: yellow; */
            outline: none;
            box-shadow: 0 0 0 2pt #c5c5c575;
        }
    </style>
    <script src="/index.js"></script>
   <script type="text/javascript">
    const escapeName = (name) => `${name}`.trim().replace(/([^a-z0-9\\w-:/]+)/gi, '-');

    window.editor = grapesjs.init({
        height: '100%',
        // width: '100%', // width is typically controlled by the container style
        container: '#gjs',
        
        showOffsets: true,
        allowScripts: 1, 
        fromElement: true,
        noticeOnUnload: false,
        storageManager: false, 
        selectorManager: { escapeName },
        plugins: [
            '@rustyroad/editor', // Ensure this is loaded once and correctly
            'grapesjs-preset-webpage',
            'grapesjs-script-editor',
            'grapesjs-component-code-editor',
            // 'grapesjs-parser-postcss', // Removed as it was causing "Plugin not found"
            '@evolvingriley/grapesjs-openai',
            () => {
                import('/static/js/location-service-standalone.bundle.js') // Load for globals/side-effects
                    .then((mod) => {
                        const init = (mod && (mod.initLocationService || (mod.default && mod.default.initLocationService)))
                          || (window.location_service && window.location_service.initLocationService);
                        if (typeof init === 'function') {
                            window.initLocationService = init;
                        } else {
                            console.info('Location component loaded; global API will be used if present.');
                        }
                    })
                    .catch(err => console.error('Error loading location component:', err));
            }
        ],
        pluginsOpts: {
            '@rustyroad/editor': { /* your options for rustyroad/editor */ },
            'grapesjs-preset-webpage': { /* your options for preset-webpage */ },
            'grapesjs-script-editor': { /* your options for script-editor */ },
            'grapesjs-component-code-editor': { /* your options for component-code-editor */ },
            '@evolvingriley/grapesjs-openai': {
                apiKey: 'YOUR_API_KEY_HERE' // As seen in logs
            }
        },
        panels: { // From runtime logs, seems to be the intended panel setup
            defaults: [
                {
                    buttons: [
                        {
                            attributes: { title: 'Open Code' },
                            className: 'fa fa-code',
                            command: 'open-code',
                            id: 'open-code'
                        },
                    ],
                    id: 'views'
                }
            ]
        },
        canvas: {
            styles: [
                '/static/css/styles.css',
                'https://unpkg.com/tailwindcss@^3/dist/tailwind.min.css'
            ],
            scripts: [
                '/static/js/funnel-client.js',
                '/static/js/location-service/dist/index.js',
                '/static/js/tracker.js',
                '/static/js/service-modal.js',
                '/static/js/pricing-table.js'
            ]
        },
    });

    editor.Panels.addButton('options', {
        id: 'update-theme',
        className: 'fa fa-adjust',
        command: 'open-update-theme',
        attributes: {
            title: 'Update Theme',
            'data-tooltip-pos': 'bottom',
        },
    });


    let isSaved = false;

    const saveHtml = (HtmlGrapesJs) => {
        if (!isSaved) {
            // save html to database
            fetch('http://localhost:8080/page', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(
                    HtmlGrapesJs
                ),
            })
                .then(response => response.json())
                .then(data => {
                    console.log('Success:', data);
                    sender.set('active', 1); // turn on the button
                })
                .catch((error) => {
                    console.error('Error:', error);
                    sender.set('active', 1); // turn on the button
                });
            isSaved = true;
        }
    };

    editor.Commands.add('savePage', {
        run(editor, sender) {
            sender.set('active', 0); // turn off the button
            
            // Get the full GrapesJS project state
            editor.store().then(state => {
                // create object to save to database
                const now = Date.now();  // milliseconds since 1970-01-01T00:00:00Z
                const GrapesJsProjectState = {
                    // Save the full state, not just HTML
                    project_state: JSON.stringify(state),
                    created_at: Math.floor(now / 1000),  // convert to seconds
                    updated_at: Math.floor(now / 1000),  // convert to seconds
                    associated_user_id: 1,
                    metadata: JSON.stringify({
                        title: 'test',
                        description: 'test',
                        keywords: 'test',
                    }),
                };
                // Use a different function to save the project state if needed,
                // or modify saveHtml to handle the new object structure.
                // For now, let's assume saveHtml can handle this object.
                const html = editor.getHtml(); // get html from grapesjs
                console.log('GrapesJsProjectState:', GrapesJsProjectState);
                console.log('HTML:', html); // log the HTML content
 
            }).catch(error => {
                console.error('Error storing GrapesJS state:', error);
                sender.set('active', 1); // turn on the button
            });
        }
    });

    editor.Panels.addButton('options', {
        id: 'savePage',
        className: 'fa fa-save',
        command: 'savePage',
        attributes: {
            title: 'Save HTML',
            'data-tooltip-pos': 'bottom',
        },
    });
</script>
</body>

</html>
