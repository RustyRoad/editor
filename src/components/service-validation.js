import AddressValidation from "./service-validation/AddressValidation";
import OrderSummary from "./service-validation/OrderSummary";
import PaymentForm from "./service-validation/PaymentForm";
import { validateServiceData } from "./service-validation/validationLogic";
export default (function (service) {
    if (!service)
        return console.error('Service data is required for validation modal');
    var validationError = validateServiceData(service);
    if (validationError)
        return validationError;
    var formattedPrice = new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: service.currency || 'USD',
    }).format(service.price);
    var buttonText = service.price > 0 ? "Pay ".concat(formattedPrice, " & Schedule") : 'Complete Setup';
    return "\n    <link href=\"https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&display=swap\" rel=\"stylesheet\">\n    <div class=\"service-validation-container p-4 md:p-6 max-w-3xl mx-auto bg-white rounded-lg shadow-lg\" style=\"font-family: 'Poppins', sans-serif;\">\n      ".concat(OrderSummary(service, formattedPrice), "\n      ").concat(AddressValidation(), "\n      ").concat(PaymentForm(buttonText), "\n    </div>\n\n    <script src=\"https://js.stripe.com/v3/\"></script>\n    <script type=\"text/javascript\" data-gjs-type=\"service-validation-script\">\n      // The JavaScript logic remains here for now\n      window.initServiceValidation = function (serviceData) {\n                            const MODAL_REOPEN_DELAY = 350; // Animation delay for modal reopening\n                            const REDIRECT_DELAY = 1500; // Delay before redirecting to checkout\n                            \n                            // Close any existing modal first\n                    if (currentModal) {\n                        handleModalClose();\n                        setTimeout(() => showServiceModal(serviceData), MODAL_REOPEN_DELAY);\n                        return;\n                    }\n      \n                    console.log(\"Showing modal for service:\", serviceData);\n      \n                    // Create modal container\n                    const modal = document.createElement('div');\n                    currentModal = modal; // Track the new modal\n      \n                    modal.style.cssText = `\n                      position:fixed; top:0; left:0; width:100%; height:100%;\n                      background:rgba(0,0,0,0.6); display:flex; justify-content:center;\n                      align-items:flex-start; z-index:1050; /* High z-index */\n                      opacity:0; transition: opacity 0.3s ease; overflow-y:auto;\n                      padding: 40px 20px; /* Padding for scroll */\n                    `;\n      \n                    // Basic validation - check for required fields\n                    if (!serviceData?.id || typeof serviceData.price !== 'number' || !serviceData.name) {\n                      console.error('Invalid service data passed to modal:', serviceData);\n                      modal.innerHTML = '<div style=\"background:white; padding:2rem; color:red; border-radius: 8px; max-width: 400px; margin-top: 40px;\">Invalid service data service validation - missing required fields (ID, Price, Title). <button id=\"error-close-btn\">Close</button></div>';\n                      document.body.appendChild(modal);\n                      document.body.style.overflow = 'hidden';\n                       // Trigger reflow before adding opacity class\n                      modal.offsetHeight;\n                      modal.style.opacity = '1';\n                      \n                      // Add event listener for close button\n                      const errorCloseBtn = modal.querySelector('#error-close-btn');\n                      if (errorCloseBtn) {\n                          errorCloseBtn.addEventListener('click', () => {\n                              modal.remove();\n                              document.body.style.overflow = '';\n                              currentModal = null;\n                          });\n                      }\n                      // Add click outside to close for error modal too\n                       modal.addEventListener('click', function(e) {\n                           if (e.target === modal) {\n                               modal.remove();\n                               document.body.style.overflow = '';\n                               currentModal = null;\n                           }\n                       });\n                      return; // Stop execution\n                    }\n      \n                    // Helper function defined within the main export scope\n                    const formatPrice = (amount, currency) => {\n                      const numAmount = Number(amount);\n                      if (isNaN(numAmount)) {\n                        // Return a default or error string if amount is not a valid number\n                        return 'N/A';\n                      }\n                       try {\n                          return new Intl.NumberFormat('en-US', {\n                            style: 'currency',\n                            currency: currency || 'USD', // Default to USD if not provided\n                          }).format(numAmount);\n                      } catch (e) {\n                           console.warn(`Modal formatPrice error: ${e.message}`);\n                          const currencySymbol = (currency || 'usd').toLowerCase() === 'usd' ? '$' : ((currency || 'USD').toUpperCase() + ' ');\n                          return `${currencySymbol}${numAmount.toFixed(2)}`;\n                      }\n                    };\n                    const formattedPrice = formatPrice(serviceData.price, serviceData.currency || 'usd');\n                    const buttonText = serviceData.price > 0 ? `Pay ${formattedPrice} & Schedule` : 'Complete Setup';\n                    const imageUrl = serviceData.imageUrl || 'https://placehold.co/64x64/e2e8f0/94a3b8?text=Icon'; // Placeholder icon\n      \n                    // --- Modal HTML ---\n                    // Ensure Tailwind is loaded on the page.\n                    modal.innerHTML = `\n                      <link href=\"https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap\" rel=\"stylesheet\">\n                       <style>\n                            /* Basic scrollbar styling for modal content */\n                            .modal-content-area::-webkit-scrollbar { width: 8px; }\n                            .modal-content-area::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }\n                            .modal-content-area::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }\n                            .modal-content-area::-webkit-scrollbar-thumb:hover { background: #555; }\n                       </style>\n                      <div class=\"modal-content-area relative p-6 md:p-8 max-w-2xl w-full mx-auto bg-white dark:bg-gray-900 rounded-xl shadow-2xl border border-gray-200 dark:border-gray-700\" style=\"font-family: 'Poppins', sans-serif; margin-top: 20px; max-height: calc(100vh - 80px); overflow-y: auto;\" onclick=\"event.stopPropagation();\">\n                        <button id=\"modal-close-button\" style=\"right: 0;\" class=\"absolute top-4 right-4 w-8 h-8 flex items-center justify-center rounded-full bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-xl text-gray-600 dark:text-gray-300 shadow focus:outline-none focus:ring-2 focus:ring-blue-500\" aria-label=\"Close\">&times;</button>\n      \n                        <div class=\"mb-6 pb-4 border-b border-gray-200 dark:border-gray-700\">\n                          <h2 class=\"text-xl font-semibold text-gray-800 dark:text-gray-100 mb-3 tracking-tight\">Order Summary</h2>\n                          <div class=\"flex items-start gap-4\">\n                            <img src=\"${imageUrl}\" alt=\"Service icon\" class=\"h-16 w-16 flex-none rounded-lg object-cover border border-gray-200 dark:border-gray-700 bg-gray-100 dark:bg-gray-800\" onerror=\"this.src='https://placehold.co/64x64/e2e8f0/94a3b8?text=Icon'; this.onerror=null;\">\n                            <div class=\"flex-auto space-y-1\">\n                              <h3 class=\"text-gray-900 dark:text-gray-100 font-semibold text-lg leading-tight\">${serviceData.name}</h3>\n                              <p class=\"text-sm text-gray-600 dark:text-gray-400\">${serviceData.description || 'Service details not available.'}</p>\n                            </div>\n                            <p class=\"flex-none text-lg font-semibold text-gray-900 dark:text-gray-100\">${formattedPrice}</p>\n                          </div>\n                          <dl id=\"order-summary-list\" class=\"mt-3 space-y-1 text-sm font-medium text-gray-700 dark:text-gray-300\">\n                            </dl>\n                          <div id=\"next-service-day-display\" class=\"mt-3 text-sm font-medium text-green-600 dark:text-green-400\"></div>\n                        </div>\n      \n                        <div id=\"address-validation-section\">\n                          <h3 class=\"text-lg font-medium text-gray-900 dark:text-gray-100 mb-3\">1.2 Check Service Availability</h3>\n                          <p class=\"text-sm text-gray-500 dark:text-gray-400 mb-4\">Please enter your address to confirm service availability.</p>\n                          <div class=\"grid grid-cols-1 gap-4\">\n                            <div>\n                              <label for=\"address1\" class=\"block text-sm font-medium text-gray-700 dark:text-gray-300\">Street Address</label>\n                              <input type=\"text\" id=\"address1\" name=\"address1\" required autocomplete=\"address-line1\" class=\"mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm\">\n                            </div>\n                            <div class=\"grid grid-cols-1 sm:grid-cols-3 gap-4\">\n                              <div>\n                                <label for=\"city\" class=\"block text-sm font-medium text-gray-700 dark:text-gray-300\">City</label>\n                                <input type=\"text\" id=\"city\" name=\"city\" required autocomplete=\"address-level2\" class=\"mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm\">\n                              </div>\n                              <div>\n                                <label for=\"state\" class=\"block text-sm font-medium text-gray-700 dark:text-gray-300\">State</label>\n                                <input type=\"text\" id=\"state\" name=\"state\" required autocomplete=\"address-level1\" class=\"mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm\">\n                              </div>\n                              <div>\n                                <label for=\"zip5\" class=\"block text-sm font-medium text-gray-700 dark:text-gray-300\">ZIP Code</label>\n                                <input type=\"text\" id=\"zip5\" name=\"zip5\" required autocomplete=\"postal-code\" class=\"mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm\">\n                              </div>\n                            </div>\n                             <div>\n                                <label for=\"trash-day\" class=\"block text-sm font-medium text-gray-700 dark:text-gray-300\">Preferred Trash Day</label>\n                                <select id=\"trash-day\" name=\"trash-day\" required class=\"mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm\">\n                                  <option value=\"\">Select a day</option>\n                                  <option value=\"Monday\">Monday</option>\n                                  <option value=\"Tuesday\">Tuesday</option>\n                                  <option value=\"Wednesday\">Wednesday</option>\n                                  <option value=\"Thursday\">Thursday</option>\n                                  <option value=\"Friday\">Friday</option>\n                                  <option value=\"Saturday\">Saturday</option>\n                                </select>\n                              </div>\n                            <div>\n                              <label for=\"email\" class=\"block text-sm font-medium text-gray-700 dark:text-gray-300\">Email</label>\n                              <input type=\"email\" id=\"email\" name=\"email\" required autocomplete=\"email\" class=\"mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm\">\n                            </div>\n                            <div class=\"flex items-center\">\n                                  <input type=\"checkbox\" id=\"subscribe_to_marketing\" name=\"subscribe_to_marketing\" class=\"h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500\" checked>\n                                  <label for=\"subscribe_to_marketing\" class=\"ml-2 block text-sm text-gray-700 dark:text-gray-300\">Subscribe to marketing emails</label>\n                            </div>\n                          </div>\n                          <button type=\"button\" id=\"check-availability\" class=\"mt-6 px-5 py-3 rounded-md bg-blue-600 text-white text-base font-medium hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 w-full sm:w-auto\">Check Availability 2</button>\n                          <div id=\"address-feedback\" class=\"mt-3 text-sm font-medium\"></div>\n                        </div>\n      \n                        <div id=\"payment-section\" class=\"hidden mt-8 pt-6 border-t border-gray-200 dark:border-gray-700\">\n                           <h3 class=\"text-lg font-medium text-gray-900 dark:text-gray-100 mb-3\">2. Billing Information</h3>\n                            <div class=\"grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4\">\n                               <div>\n                                   <label for=\"first-name\" class=\"block text-sm font-medium text-gray-700 dark:text-gray-300\">First Name</label>\n                                   <input type=\"text\" id=\"first-name\" name=\"first-name\" required autocomplete=\"given-name\" class=\"mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm\">\n                               </div>\n                               <div>\n                                   <label for=\"last-name\" class=\"block text-sm font-medium text-gray-700 dark:text-gray-300\">Last Name</label>\n                                   <input type=\"text\" id=\"last-name\" name=\"last-name\" required autocomplete=\"family-name\" class=\"mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm\">\n                               </div>\n                           </div>\n                           <form id=\"payment-form\">\n                               <div id=\"payment-element\" class=\"mb-4\"></div>                         <button id=\"submit-button\" class=\"w-full rounded-md bg-green-600 px-6 py-3 text-white font-medium hover:bg-green-700 disabled:opacity-50\">Submit Payment</button>\n                               <div id=\"payment-message\" class=\"hidden mt-2 text-sm text-red-600 dark:text-red-400\"></div>\n                           </form>\n                         </div>\n      \n                      </div>\n                    `;\n      \n                    // Append modal to body and fade in\n                    document.body.appendChild(modal);\n                    document.body.style.overflow = 'hidden'; // Prevent body scrolling\n                    // Trigger reflow before adding opacity class\n                    modal.offsetHeight;\n                    modal.style.opacity = '1';\n      \n                    // --- Attach Modal Event Listeners ---\n                    const closeButton = modal.querySelector('#modal-close-button');\n                    if (closeButton) {\n                        closeButton.addEventListener('click', handleModalClose);\n                    }\n                    // Close when clicking background overlay\n                    modal.addEventListener('click', (e) => {\n                        if (e.target === modal) {\n                            handleModalClose();\n                        }\n                    });\n      \n                    // --- Service Validation Logic ---\n                    const address1Input = modal.querySelector('#address1');\n                    const cityInput = modal.querySelector('#city');\n                    const stateInput = modal.querySelector('#state');\n                    const zip5Input = modal.querySelector('#zip5');\n                    const checkBtn = modal.querySelector('#check-availability');\n                    const addressFeedbackDiv = modal.querySelector('#address-feedback');\n                    const emailInput = modal.querySelector('#email');\n                    const subscribeToMarketing = modal.querySelector('#subscribe_to_marketing');\n                    const trashDaySelect = modal.querySelector('#trash-day'); // Added selector for trash day\n      \n      \n                    function setAddressFeedback(msg, type = 'info') {\n                      if (!addressFeedbackDiv) return;\n                      addressFeedbackDiv.textContent = msg;\n                      addressFeedbackDiv.className = 'mt-3 text-sm font-medium'; // Reset classes\n                      switch (type) {\n                        case 'success': addressFeedbackDiv.classList.add('text-green-600', 'dark:text-green-400'); break;\n                        case 'error': addressFeedbackDiv.classList.add('text-red-600', 'dark:text-red-400'); break;\n                        case 'loading': addressFeedbackDiv.classList.add('text-blue-600', 'dark:text-blue-400'); break;\n                        default: addressFeedbackDiv.classList.add('text-gray-600', 'dark:text-gray-300');\n                      }\n                    }\n      \n                    let stripe;\n                    let elements;\n                    let paymentElement;\n                    let clientSecret; // Store client secret\n      \n                    const fetchStripeKey = async () => {\n                        // Prefer key from serviceData if provided (e.g., different keys per service)\n                        if (serviceData && serviceData.stripeKey) {\n                            return serviceData.stripeKey;\n                        }\n                        // Otherwise fetch default key\n                        try {\n                            const response = await fetch('/settings/stripe-api-key'); // Ensure this endpoint exists and returns JSON { stripe_api_key: \"pk_...\" }\n                            if (!response.ok) throw new Error(`Failed to fetch Stripe key (${response.status})`);\n                            const data = await response.json();\n                            if (!data?.stripe_api_key) throw new Error('Stripe key not found in response');\n                            return data.stripe_api_key;\n                        } catch (err) {\n                            console.error('Error fetching Stripe key:', err);\n                            setAddressFeedback(`Error fetching payment settings: ${err.message}`, 'error');\n                            return null;\n                        }\n                    };\n      \n                    // Initialize Stripe.js and Elements\n                    async function initializeStripeElements() {\n                        try {\n                            // Load Stripe.js if not already loaded\n                            if (typeof Stripe === 'undefined') {\n                                setAddressFeedback('Loading payment library...', 'loading');\n                                await new Promise((resolve, reject) => {\n                                    const script = document.createElement('script');\n                                    script.src = 'https://js.stripe.com/v3/';\n                                    script.async = true;\n                                    script.onload = resolve;\n                                    script.onerror = reject;\n                                    document.head.appendChild(script);\n                                });\n                                 setAddressFeedback('Payment library loaded.', 'info');\n                            }\n      \n                            const publishableKey = await fetchStripeKey();\n                            if (!publishableKey) return false; // Error handled in fetchStripeKey\n      \n                            stripe = Stripe(publishableKey);\n\n                            // Check if geocode data is already in local storage\n                            try {\n                                const geocodeData = localStorage.getItem('geocode-data');\n                                if (geocodeData) {\n                                    console.log('Geocode data found in local storage: service validation', geocodeData);\n                                    window.lastValidatedAddressForModal = JSON.parse(geocodeData); // Store for later use\n                                } else {\n                                    console.log('No geocode data found in local storage.');\n                                }\n                            } catch (err) {\n                                console.error('Error retrieving geocode data from local storage:', err);\n                            }\n\n                            // --- Create Payment Intent / Checkout Session ---\n                            // This MUST happen after address validation passes.\n                            // Moved the fetch call here.\n                            setAddressFeedback('Initializing payment...', 'loading');\n                            const sessionResponse = await fetch('/api/stripe/checkout-sessions', { // Ensure this endpoint is correct\n                                method: 'POST',\n                                headers: { 'Content-Type': 'application/json' },\n                                body: JSON.stringify({\n                                  product_id: String(serviceData.id), // Ensure ID is string\n                                  first_name: modal.querySelector('#first-name')?.value || '',\n                                  last_name: modal.querySelector('#last-name')?.value || '',\n                                  email: localStorage.getItem('geocode-data') ? JSON.parse(localStorage.getItem('geocode-data')).email : '',\n                                    address_id: Number(window.lastValidatedAddressForModal.address_id), // Convert to number\n                                    trash_day: window.lastValidatedAddressForModal.trash_day,\n                                    additional_bins: window.additionalBins,\n                                    location: window.lastValidatedAddressForModal.location\n                                })\n                            });\n\n                            if (!sessionResponse.ok) {\n                                let errorMsg = `Failed to initialize payment (${sessionResponse.status})`;\n                                try { const errorData = await sessionResponse.json(); errorMsg = errorData.message || errorMsg; }\n                                catch (parseError) { console.error('Error parsing payment init error response:', parseError); }\n                                throw new Error(errorMsg);\n                            }\n      \n                            const responseData = await sessionResponse.json();\n                            console.log('Stripe init response:', responseData);\n      \n                            // --- Check Response and Get Client Secret ---\n                            // Adapt based on whether you use Payment Intents or Checkout Sessions\n                            // Example for Payment Intent:\n                            clientSecret = responseData.client_secret; // Assuming backend returns { client_secret: \"pi_...\" }\n                            if (!clientSecret) {\n                                 throw new Error('Missing client_secret from payment initialization response.');\n                            }\n                            \n                            // Track initiate checkout event\n                            if (window.trackEvent) {\n                                window.trackEvent('initiate_checkout', {\n                                    value: responseData?.amount_total || serviceData.price,\n                                    currency: serviceData.currency || 'USD',\n                                    step: 1,\n                                    checkout_option: 'standard',\n                                    items: [{\n                                        item_id: String(serviceData.id),\n                                        name: serviceData.name || 'Service',\n                                        price: serviceData.price,\n                                        quantity: 1\n                                    }]\n                                });\n                            }\n      \n                             // --- Update Order Summary with Tax/Total from Backend ---\n                             const taxAmount = responseData.tax_amount ?? 0; // Adjust key based on your API response\n                             const subtotal = responseData.subtotal ?? 0; // Adjust key\n                             const amountTotal = responseData.total ?? responseData.amount_total ?? 0; // Adjust key\n                             const currency = serviceData.currency || 'USD';\n      \n                             const formatOrderPrice = (amount) => {\n                                 const numAmount = Number(amount) / 100; // Assuming amount is in cents\n                                 if (isNaN(numAmount)) return 'N/A';\n                                 return new Intl.NumberFormat('en-US', { style: 'currency', currency: currency }).format(numAmount);\n                             };\n      \n                             const orderSummaryList = modal.querySelector('#order-summary-list');\n                             if (orderSummaryList) {\n                                 orderSummaryList.innerHTML = `\n                                   ${subtotal > 0 ? `\n                                     <div class=\"flex items-center justify-between pt-1\">\n                                       <dt>Subtotal</dt>\n                                       <dd>${formatOrderPrice(subtotal)}</dd>\n                                     </div>` : ''}\n                                   <div class=\"flex items-center justify-between pt-1\">\n                                     <dt>Tax</dt>\n                                     <dd>${formatOrderPrice(taxAmount)}</dd>\n                                   </div>\n                                   <div class=\"flex items-center justify-between pt-1 font-semibold text-gray-900 dark:text-gray-100\">\n                                     <dt>Total</dt>\n                                     <dd>${formatOrderPrice(amountTotal)}</dd>\n                                   </div>\n                                 `;\n                             }\n      \n      \n                            // --- Initialize Stripe Elements ---\n                            elements = stripe.elements({\n                                clientSecret: clientSecret,\n                                appearance: {\n                                    theme: 'stripe', // or 'night', 'flat', 'none'\n                                    variables: { colorPrimary: '#2563eb', /* ... other theme vars */ }\n                                }\n                            });\n      \n                            // Create and mount the Payment Element\n                            paymentElement = elements.create('payment');\n                            paymentElement.mount('#payment-element'); // Mount in the payment section\n                            setAddressFeedback('Please enter payment details.', 'info'); // Update feedback\n      \n                            // --- Show Payment Section ---\n                            const addressSection = modal.querySelector('#address-validation-section');\n                            const paymentSection = modal.querySelector('#payment-section');\n                            if(addressSection) addressSection.style.display = 'none'; // Hide address form\n                            if(paymentSection) paymentSection.classList.remove('hidden'); // Show payment form\n      \n                            return true; // Indicate success\n      \n                        } catch (err) {\n                            console.error('Stripe initialization failed:', err);\n                            setAddressFeedback(`Payment setup failed: ${err.message}`, 'error');\n                            // Optionally re-enable check availability button or provide retry mechanism\n                            const checkBtn = modal.querySelector('#check-availability');\n                            if(checkBtn) checkBtn.disabled = false;\n                            return false; // Indicate failure\n                        }\n                    } // End initializeStripeElements\n      \n                    // Handle Payment Form Submission\n                    async function handlePaymentSubmit(event) {\n                        event.preventDefault();\n                        if (!stripe || !elements || !clientSecret) {\n                            console.error('Stripe not initialized for payment submission.');\n                            setPaymentMessage('Payment system error. Please refresh and try again.');\n                            return;\n                        }\n      \n                        const submitBtn = modal.querySelector('#submit-button');\n                        const paymentMsgDiv = modal.querySelector('#payment-message');\n      \n                        submitBtn.disabled = true;\n                        setPaymentMessage('Processing payment...', 'loading');\n      \n                        // Collect billing details if needed (some might be optional depending on Stripe settings)\n                        const billingDetails = {\n                             name: `${modal.querySelector('#first-name')?.value || ''} ${modal.querySelector('#last-name')?.value || ''}`.trim(),\n                             email: emailInput.value.trim(), // Use email from address section\n                             // Address details can also be passed if needed and not collected by Payment Element\n                             // address: {\n                             //    line1: address1Input.value.trim(),\n                             //    city: cityInput.value.trim(),\n                             //    state: stateInput.value.trim(),\n                             //    postal_code: zip5Input.value.trim(),\n                             //    country: 'US', // Assuming US\n                             // }\n                        };\n      \n      \n                        const { error } = await stripe.confirmPayment({\n                            elements,\n                            confirmParams: {\n                                return_url: window.location.origin + '/thank-you', // Your success page URL\n                                receipt_email: emailInput.value.trim(),\n                                payment_method_data: {\n                                     billing_details: billingDetails\n                                },\n                            },\n                            // Uncomment if you need to handle immediate success/failure without redirect\n                            // redirect: 'if_required'\n                        });\n      \n                        if (error) {\n                            // This point will only be reached if there is an immediate error when confirming the payment.\n                            // Otherwise, your customer will be redirected to your return_url.\n                            // If you are handling server-side confirmation, error messages will be displayed automatically.\n                            console.error('Stripe confirmPayment error:', error);\n                            setPaymentMessage(error.message || 'An unexpected error occurred.', 'error');\n                            submitBtn.disabled = false; // Re-enable button on error\n                        } else {\n                             // Payment submitted successfully (or requires further action like 3DS)\n                             // If redirect: 'if_required' was used, check paymentIntent status here.\n                             setPaymentMessage('Payment successful! Redirecting...', 'success');\n                             \n                             // Track booking completion\n                             if (window.trackEvent) {\n                                 const bookingId = clientSecret.split('_secret')[0];\n                                 window.trackEvent('booking_completed', {\n                                     booking_id: bookingId,\n                                     service_type: serviceData.service_type || 'bin_cleaning',\n                                     date: new Date().toISOString(),\n                                     value: serviceData.price,\n                                     currency: serviceData.currency || 'USD',\n                                     items: [{\n                                         item_id: serviceData.id,\n                                         name: serviceData.name,\n                                         price: serviceData.price,\n                                         quantity: 1\n                                     }]\n                                 });\n                             }\n                             \n                             // Redirect is handled by Stripe by default unless redirect: 'if_required' is used.\n                        }\n                    } // End handlePaymentSubmit\n      \n                    function setPaymentMessage(msg, type = 'info') {\n                        const paymentMsgDiv = modal.querySelector('#payment-message');\n                        if (!paymentMsgDiv) return;\n                        paymentMsgDiv.textContent = msg;\n                        paymentMsgDiv.className = 'mt-2 text-sm'; // Reset classes\n                        switch (type) {\n                            case 'success': paymentMsgDiv.classList.add('text-green-600', 'dark:text-green-400'); break;\n                            case 'error': paymentMsgDiv.classList.add('text-red-600', 'dark:text-red-400'); break;\n                            case 'loading': paymentMsgDiv.classList.add('text-blue-600', 'dark:text-blue-400'); break;\n                            default: paymentMsgDiv.classList.add('text-gray-600', 'dark:text-gray-300');\n                        }\n                        paymentMsgDiv.classList.remove('hidden');\n                    }\n      \n      \n                    // --- Attach Event Listener for Address Check ---\n                    if (checkBtn && addressFeedbackDiv) {\n                        checkBtn.addEventListener('click', async () => {\n                            // Basic frontend validation\n                            if (!address1Input.value.trim() || !cityInput.value.trim() || !stateInput.value.trim() || !zip5Input.value.trim() || !emailInput.value.trim() || !trashDaySelect.value) {\n                                setAddressFeedback('Please fill in all address fields, email, and preferred trash day. 2', 'error');\n                                return;\n                            }\n                             if (!/^S+@S+.S+$/.test(emailInput.value.trim())) {\n                                 setAddressFeedback('Please enter a valid email address.', 'error');\n                                 return;\n                             }\n      \n      \n                            const address = {\n                                line1: address1Input.value.trim(),\n                                line2: null, // Add line2 input if needed\n                                city: cityInput.value.trim(),\n                                state: stateInput.value.trim(),\n                                postal_code: zip5Input.value.trim(),\n                                country: \"US\" // Assuming US\n                            };\n                            const trashDay = trashDaySelect.value;\n      \n                            setAddressFeedback('Checking availability... 2', 'loading');\n                            checkBtn.disabled = true;\n      \n                            try {\n                                // --- Call your Geocode/Validation API ---\n                                const resp = await fetch('/api/geocode', { // Ensure this endpoint exists\n                                    method: 'POST',\n                                    headers: { 'Content-Type': 'application/json' },\n                                    body: JSON.stringify({\n                                        address,\n                                        email: emailInput.value.trim(),\n                                        trash_day: trashDay,\n                                        subscribe_to_marketing: subscribeToMarketing.checked,\n                                        // Optionally pass serviceId if validation depends on it\n                                        // service_id: serviceData.id\n                                    })\n                                });\n      \n                                if (!resp.ok) {\n                                     let errorMsg = `Address validation failed (${resp.status})`;\n                                     try { const errorData = await resp.json(); errorMsg = errorData.message || errorMsg; }\n                                     catch(e){ console.error(\"Could not parse error response from /api/geocode\"); }\n                                     throw new Error(errorMsg);\n                                }\n      \n                                const data = await resp.json();\n                                console.log('Geocode response:', data);\n      \n                                // --- Handle Validation Response ---\n                                if (!data.inside_zone) {\n                                    setAddressFeedback('Sorry, service is not currently available at this address.', 'error');\n                                    checkBtn.disabled = false; // Re-enable button\n                                    return;\n                                }\n                                 if (!data.valid_trash_day) { // Check if trash day is valid for the zone/address\n                                     setAddressFeedback(`Trash day (${trashDay}) is not valid for this service area. Please check collection schedule or contact support.`, 'error');\n                                     checkBtn.disabled = false; // Re-enable button\n                                     return;\n                                 }\n      \n                                // --- Success: Redirect to Checkout ---\n                                setAddressFeedback(`Service available! ${data.next_service_day ? 'Next estimated service day: ' + data.next_service_day : ''}`, 'success');\n                                \n                                // Track address validation success\n                                if (window.trackEvent) {\n                                    const analyticsData = {\n                                        event_id: data.address_id,\n                                        value: serviceData.price,\n                                        currency: serviceData.currency || 'USD',\n                                        items: [{ item_id: serviceData.id, price: serviceData.price, quantity: 1 }]\n                                    };\n\n                                    window.trackEvent('address_entered', {\n                                        ...analyticsData,\n                                        step: 2,\n                                        address_type: 'shipping',\n                                        form_id: 'service-booking'\n                                    });\n\n                                    // Unified e-commerce tracking\n                                    window.trackEvent('add_to_cart', analyticsData);\n                                }\n                                \n                                // Check if server returned a redirect URL (preferred method)\n                                if (data.redirect_url) {\n                                    console.log('Redirecting to checkout:', data.redirect_url);\n                                    setAddressFeedback('Address validated! Redirecting to checkout...', 'success');\n                                    \n                                    // Close modal and redirect after a short delay\n                                    setTimeout(() => {\n                                        if (currentModal) {\n                                            currentModal.remove();\n                                            document.body.style.overflow = '';\n                                            currentModal = null;\n                                        }\n                                        window.location.href = data.redirect_url;\n                                    }, REDIRECT_DELAY);\n                                    return;\n                                }\n                                \n                                // Fallback: construct redirect URL manually if not provided by server\n                                let redirectUrl = '/checkout?';\n                                const params = new URLSearchParams();\n                                if (serviceData.id) params.append('service_id', serviceData.id);\n                                if (data.address_id) params.append('address_id', data.address_id);\n                                if (emailInput.value.trim()) params.append('email', emailInput.value.trim());\n                                if (trashDaySelect.value) params.append('trash_day', trashDaySelect.value);\n                if (data.next_service_day) params.append('next_service_day', data.next_service_day);\n                // Ensure postal code is always included for tax calculation\n                if (zip5Input && zip5Input.value && zip5Input.value.trim()) {\n                  params.append('zip5', zip5Input.value.trim());\n                }\n                                \n                                redirectUrl += params.toString();\n                                console.log('Fallback redirect to checkout:', redirectUrl);\n                                setAddressFeedback('Address validated! Redirecting to checkout...', 'success');\n                                \n                                // Close modal and redirect after a short delay\n                                setTimeout(() => {\n                                    if (currentModal) {\n                                        currentModal.remove();\n                                        document.body.style.overflow = '';\n                                        currentModal = null;\n                                    }\n                                    if (redirectUrl.startsWith('/checkout?')) {\n                                        window.location.href = redirectUrl;\n                                    } else {\n                                        console.error('Invalid redirect URL:', redirectUrl);\n                                        setAddressFeedback('Error: Invalid redirect URL.', 'error');\n                                    }\n                                }, REDIRECT_DELAY);\n      \n                            } catch (err) {\n                                console.error('Availability check error:', err);\n                                setAddressFeedback(`Error checking availability: ${err.message}`, 'error');\n                                checkBtn.disabled = false; // Re-enable button on error\n                            }\n                            // 'finally' block removed as button re-enabling is handled in error cases\n      \n                        }); // End checkBtn listener\n                    } else {\n                        console.error(\"Could not find address check button or feedback div in modal.\");\n                    }\n      \n                  // End of showServiceModal\n      };\n    </script>\n  ");
});
